define(["require","app/helpers/debugger","app/helpers/cookie","app/models/cache"],function(e,t,n,r){var i={user:{},friends:[],activity:{}};return i.init=function(e,n){var r=this;return t.log("Initiliazing Facebook",0),$("body").prepend('<div id="fb-root"></div>'),t.log("Prepended div fb-root to body"),window.fbAsyncInit=function(){return t.log("Loading the SDK asynchronously with app id: "+e),FB.init({appId:e,channelUrl:"//localhost:8888/wordpress/channel.html",status:!0,cookie:!0,xfbml:!0}),t.log("SDK loaded"),t.log("Finished"),n()},function(e,t){var n,r,i;r=void 0,n="facebook-jssdk",i=e.getElementsByTagName("script")[0];if(e.getElementById(n))return;return r=e.createElement("script"),r.id=n,r.async=!0,r.src="//connect.facebook.net/en_US/all"+(t?"/debug":"")+".js",i.parentNode.insertBefore(r,i)}(window.document,!1)},i.is_logged_in=function(e){var n=this;return t.log("See if user is logged in to Facebook and the app",0),t.log("Query Facebook"),FB.getLoginStatus(function(r){return t.log("Response from Facebook received"),r.status==="connected"?(t.log("User is logged in"),n.user.logged_in=!0,t.log("Finished"),e(!0)):(t.log("User is not logged in"),n.user.logged_in=!1,t.log("Finished"),e(!1))})},i.get_user=function(e){var n=this;return t.log("Get Facebook user",0),t.log("Querying Facebook"),FB.api("/me",function(r){return t.log("Response received, setting values"),n.user.id=r.id,n.user.name=r.name,n.user.link=r.link,n.user.picture="//graph.facebook.com/"+r.id+"/picture",t.log("Finished"),e(n.user)})},i.login=function(e){var n=this;return t.log("Logging in the user to Facebook",0),FB.login(function(n){t.log("Response received from Facebook");if(n.status!=="connected")return t.log("User cancelled login or did not fully authorize.");t.log("Logged in successfully"),e()},{scope:"publish_actions"})},i.logout=function(e){var n=this;return t.log("Logging the user out of Facebook",0),FB.logout(function(n){t.log("Logout successful"),t.log("Removing cached coookie NEED TO DO THIS"),t.log("Reloading the page"),e()})},i.add_read=function(e){var n=this;return t.log("Adding user read",0),FB.api("/me/news.reads?article="+document.URL,"post",function(n){t.log("Response received from Facebook"),n.id?t.log("Read "+n.id+" posted to Facebook: SUCCESS"):(t.log("Read posted to Facebook: FAILURE"),t.log("Error message from Facebook: "+n.error.message+" ")),t.log("Finished");if(e!==null)return e()})},i.delete_read=function(e,n){var r=this;return t.log("Deleting user read",0),FB.api("/"+e,"delete",function(e){return t.log("Response received from Facebook"),e===!0?t.log("Read deleted from Facebook: SUCCESS"):(t.log("Read deleted from Facebook: FAILURE"),t.log("Error message from Facebook: #{response.error.message}")),n()})},i.get_friend_users=function(e){var i=this;t.log("Get Facebook friends using the app",0);if(!n.exists("sr_friends_cache"))return t.log("Friends not in cache, querying Facebook"),FB.api("/me/friends?fields=name,installed",function(n){var s,o,u,a;t.log("Response received, finding friend users"),a=n.data;for(o=0,u=a.length;o<u;o++)s=a[o],s.installed===!0&&(delete s.installed,i.friends.push(s));t.log(""+i.friends.length+" friends found"),t.log("Finished"),r.save(i.user.id,"friends_cache",i.friends,function(){e(i.friends)})});t.log("Friends in cache, get from server"),r.get(i.user.id,"friends_cache",function(t){i.friends=t,e!==null&&e(i.friends)})},i.get_activity=function(e){var i,s,o,u,a,f=this;t.log("Getting activity of you and friends",0);if(!n.exists("sr_activity_cache")){t.log("Activity reads does not exist, create and fetch from Facebook"),this.activity.reads=[],t.log("Creating batch array"),i=[],i.push({method:"GET",relative_url:"me/news.reads?fields=id,comment_info,comments,comment_info,likes,like_info,data,publish_time,from"}),a=this.friends;for(o=0,u=a.length;o<u;o++)s=a[o],i.push({method:"GET",relative_url:""+s.id+"/news.reads?fields=id,comment_info,comments,comment_info,likes,like_info,data,publish_time,from"});return t.log("Starting batch requests for the "+this.friends.length+" friends using this app"),FB.api("/","POST",{batch:i},function(n){var i,s,o,u,a,l,c,h;t.log("Response received from Facebook"),t.log("Added reads to reads param array");for(u=0,l=n.length;u<l;u++){o=n[u];if(!o||!o.body)continue;i=JSON.parse(o.body),h=i.data;for(a=0,c=h.length;a<c;a++)s=h[a],f.activity.reads.push(s)}t.log("Sorting the reads by publish_time descending"),f.activity.reads=f.activity.reads.sort(function(e,t){return e=new Date(e.publish_time),t=new Date(t.publish_time),e>t?-1:e<t?1:0}),t.log("Finished"),r.save(f.user.id,"activity_cache",f.activity,function(){e()})})}t.log("Activity in cache, get from server"),r.get(f.user.id,"activity_cache",function(t){f.activity=t,e!==null&&e(f.activity)})},i});