define("app/helpers/debugger",[],function(){var e={};return e.start=function(){return this.check_parameter_exists("sr_debug")?(this.debug_mode=!0,console.log("***********************************************\n* Welcome to the Social Reader debug console! *\n***********************************************")):this.debug_mode=!1},e.log=function(e,t){t==null&&(t=1);if(this.debug_mode===!0){if(t===1)return console.log("  * "+e);if(t===0)return console.log("\n"+e+":")}},e.check_parameter_exists=function(e){var t,n,r,i,s,o;n=window.location.search.substring(1),s=0,o="?";if(n.length>0){i=n.split("&"),r=0;while(r<i.length){t=i[r].split("=");if(t[0]===e)return!0;r++}}return!1},e.start(),e}),define("app/helpers/cookie",["require"],function(){var e={};return e.set=function(e,t,n){var r,i;return i=new Date,i.setDate(i.getDate()+n),r=escape(t)+(n==null?"":"; expires="+i.toUTCString()),document.cookie=e+"="+r},e.get=function(e){var t,n,r,i;t=document.cookie.split(";"),n=0;while(n<t.length){r=t[n].substr(0,t[n].indexOf("=")),i=t[n].substr(t[n].indexOf("=")+1),r=r.replace(/^\s+|\s+$/g,"");if(r===e)return unescape(i);n++}},e.exists=function(e){var t=this.get(e);return t!==null?!0:!1},e.remove=function(e){return document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;"},e}),define("app/models/cache",["require","app/helpers/debugger","app/helpers/cookie"],function(e,t,n){var r={};return r.save=function(e,r,i,s){t.log("Saving "+r+" to the database cache",0);var o=this,u=JSON.stringify(i);return $.post(_sr_ajax.ajaxurl,{action:"_sr_ajax_hook",type:"save_cache",fb_id:e,field:r,data:u},function(e){t.log("Ajax request complete"),e=="1"?(t.log(r+" saved successfully"),n.set("sr_"+r,"true",null),t.log("Set cookie marking "+r+" as saved this session"),t.log("Finished"),s!==null&&s()):(t.log("Data failed to save"),t.log("Finished"),s!==null&&s())})},r.get=function(e,n,r){var i=this;return t.log("Getting the "+n),$.post(_sr_ajax.ajaxurl,{action:"_sr_ajax_hook",type:"get_cache",fb_id:e,field:n},function(e){t.log("Ajax request complete"),t.log("Converting data to json object");try{var n=JSON.parse(e);t.log("JSON parsed: SUCCESS"),t.log("Finished"),r!==null&&r(n)}catch(i){t.log("JSON parsed: FAILURE"),t.log("Finished"),r!==null&&r()}})},r}),define("app/models/fb",["require","app/helpers/debugger","app/helpers/cookie","app/models/cache"],function(e,t,n,r){var i={user:{},friends:[],activity:{}};return i.init=function(e,n){var r=this;return t.log("Initiliazing Facebook",0),$("body").prepend('<div id="fb-root"></div>'),t.log("Prepended div fb-root to body"),window.fbAsyncInit=function(){return t.log("Loading the SDK asynchronously with app id: "+e),FB.init({appId:e,channelUrl:"//localhost:8888/wordpress/channel.html",status:!0,cookie:!0,xfbml:!0}),t.log("SDK loaded"),t.log("Finished"),n()},function(e,t){var n,r,i;r=void 0,n="facebook-jssdk",i=e.getElementsByTagName("script")[0];if(e.getElementById(n))return;return r=e.createElement("script"),r.id=n,r.async=!0,r.src="//connect.facebook.net/en_US/all"+(t?"/debug":"")+".js",i.parentNode.insertBefore(r,i)}(window.document,!1)},i.is_logged_in=function(e){var n=this;return t.log("See if user is logged in to Facebook and the app",0),t.log("Query Facebook"),FB.getLoginStatus(function(r){return t.log("Response from Facebook received"),r.status==="connected"?(t.log("User is logged in"),n.user.logged_in=!0,t.log("Finished"),e(!0)):(t.log("User is not logged in"),n.user.logged_in=!1,t.log("Finished"),e(!1))})},i.get_user=function(e){var n=this;return t.log("Get Facebook user",0),t.log("Querying Facebook"),FB.api("/me",function(r){return t.log("Response received, setting values"),n.user.id=r.id,n.user.name=r.name,n.user.link=r.link,n.user.picture="//graph.facebook.com/"+r.id+"/picture",t.log("Finished"),e(n.user)})},i.login=function(e){var n=this;return t.log("Logging in the user to Facebook",0),FB.login(function(n){t.log("Response received from Facebook");if(n.status!=="connected")return t.log("User cancelled login or did not fully authorize.");t.log("Logged in successfully"),e()},{scope:"publish_actions"})},i.logout=function(e){var n=this;return t.log("Logging the user out of Facebook",0),FB.logout(function(n){t.log("Logout successful"),t.log("Removing cached coookie NEED TO DO THIS"),t.log("Reloading the page"),e()})},i.add_read=function(e){var n=this;return t.log("Adding user read",0),FB.api("/me/news.reads?article="+document.URL,"post",function(n){t.log("Response received from Facebook"),n.id?t.log("Read "+n.id+" posted to Facebook: SUCCESS"):(t.log("Read posted to Facebook: FAILURE"),t.log("Error message from Facebook: "+n.error.message+" ")),t.log("Finished");if(e!==null)return e()})},i.delete_read=function(e,n){var r=this;return t.log("Deleting user read",0),FB.api("/"+e,"delete",function(e){return t.log("Response received from Facebook"),e===!0?t.log("Read deleted from Facebook: SUCCESS"):(t.log("Read deleted from Facebook: FAILURE"),t.log("Error message from Facebook: #{response.error.message}")),n()})},i.get_friend_users=function(e){var i=this;t.log("Get Facebook friends using the app",0);if(!n.exists("sr_friends_cache"))return t.log("Friends not in cache, querying Facebook"),FB.api("/me/friends?fields=name,installed",function(n){var s,o,u,a;t.log("Response received, finding friend users"),a=n.data;for(o=0,u=a.length;o<u;o++)s=a[o],s.installed===!0&&(delete s.installed,i.friends.push(s));t.log(""+i.friends.length+" friends found"),t.log("Finished"),r.save(i.user.id,"friends_cache",i.friends,function(){e(i.friends)})});t.log("Friends in cache, get from server"),r.get(i.user.id,"friends_cache",function(t){i.friends=t,e!==null&&e(i.friends)})},i.get_activity=function(e){var i,s,o,u,a,f=this;t.log("Getting activity of you and friends",0);if(!n.exists("sr_activity_cache")){t.log("Activity reads does not exist, create and fetch from Facebook"),this.activity.reads=[],t.log("Creating batch array"),i=[],i.push({method:"GET",relative_url:"me/news.reads?fields=id,comment_info,comments,comment_info,likes,like_info,data,publish_time,from"}),a=this.friends;for(o=0,u=a.length;o<u;o++)s=a[o],i.push({method:"GET",relative_url:""+s.id+"/news.reads?fields=id,comment_info,comments,comment_info,likes,like_info,data,publish_time,from"});return t.log("Starting batch requests for the "+this.friends.length+" friends using this app"),FB.api("/","POST",{batch:i},function(n){var i,s,o,u,a,l,c,h;t.log("Response received from Facebook"),t.log("Added reads to reads param array");for(u=0,l=n.length;u<l;u++){o=n[u];if(!o||!o.body)continue;i=JSON.parse(o.body),h=i.data;for(a=0,c=h.length;a<c;a++)s=h[a],f.activity.reads.push(s)}t.log("Sorting the reads by publish_time descending"),f.activity.reads=f.activity.reads.sort(function(e,t){return e=new Date(e.publish_time),t=new Date(t.publish_time),e>t?-1:e<t?1:0}),t.log("Finished"),r.save(f.user.id,"activity_cache",f.activity,function(){e()})})}t.log("Activity in cache, get from server"),r.get(f.user.id,"activity_cache",function(t){f.activity=t,e!==null&&e(f.activity)})},i}),define("app/models/user",["require","app/models/fb","app/helpers/cookie","app/helpers/debugger"],function(e,t,n,r){var i=jQuery,s={};return s.init=function(e,n){var r=this;this.site={},this.user={},this.friends=[],this.activity={},this.get_client_details(function(){t.init(r.site.fb_app_id,function(){t.is_logged_in(function(i){if(i!==!0)return e();t.get_user(function(s){r.user=s,r.user.logged_in=i,r.is_auto_sharing(function(){e(),t.get_friend_users(function(e){r.friends=e,t.get_activity(function(e){r.activity=e,n()})})})})})})})},s.get_client_details=function(e){var t=this;return r.log("Getting client site details",0),i.post(_sr_ajax.ajaxurl,{action:"_sr_ajax_hook",type:"get_client_details"},function(n){return r.log("Ajax request complete"),t.site=JSON.parse(n),t.site?r.log("Read from ajax request data: SUCCESS"):r.log("Read from ajax request data: FAILURE"),r.log("Finished"),e()})},s.is_auto_sharing=function(e){var t=this;return r.log("See if we're auto sharing"),i.post(_sr_ajax.ajaxurl,{action:"_sr_ajax_hook",type:"is_auto_sharing",fb_id:this.user.id},function(n){return r.log("Ajax request complete"),n==1||n==0?(r.log("SUCCESS, set param"),n==1?n=!0:n=!1,t.user.auto_sharing=n,r.log("Finished")):(r.log("Data format is incorrect. FAILURE"),console.log(n)),e()})},s.set_auto_sharing=function(e){var t=this;return r.log("Setting auto sharing",0),r.log("Changing auto sharing to "+e),i.post(_sr_ajax.ajaxurl,{action:"_sr_ajax_hook",type:"set_auto_sharing",fb_id:this.user.id,is_auto_sharing:e},function(e){r.log("Ajax request complete"),e==1?r.log("Auto sharing change: SUCCESS"):r.log("Auto sharing change: FAILURE"),r.log("Finished")})},s.login=function(){t.login(function(){window.location.reload()})},s.logout=function(){t.logout(function(){n.remove("sr_activity_cache"),n.remove("sr_friends_cache"),window.location.reload()})},s}),define("app/helpers/time",[],function(){var e={};return e.relative=function(e){var t,n,r,i,s,o,u;return u=(new Date(fb_time)).getTime(),i=6e4,r=i*60,n=r*24,s=n*30,o=n*365,t=(new Date).getTime()-u,t<i?Math.round(t/1e3)+" seconds ago":t<r?Math.round(t/i)+" minutes ago":t<n?Math.round(t/r)+" hours ago":t<s?Math.round(t/n)+" days ago":t<o?Math.round(t/s)+" months ago":Math.round(t/o)+" years ago"},e}),define("app/controllers/lightbox",["require","app/helpers/debugger","app/models/user","app/helpers/time"],function(e,t,n,r){var i={};return i.load=function(e,n){this.user=e,this.site=n;var r=this;return t.log("Loading the lightbox",0),e.logged_in===!1?(t.log("User is not logged in, don't load it"),t.log("Finished"),!1):(t.log("Prepending lightbox to <body>"),$("<div/>",{id:"sr_lightbox",html:"<div id='sr_lightbox_inner'></div>"}).prependTo("body"),$("#sr_lightbox_inner").length!==0?t.log("Lightbox added: SUCCESS"):t.log("Lightbox added: FAILURE"),this.setup_listeners(),t.log("Finished"))},i.setup_listeners=function(){var e=this;t.log("Setup jQuery listener for close lightbox link click"),$("a#sr_close_lightbox").live("click",function(){return e.close()})},i.show=function(e,n){var r=this;return t.log("Fade in lightbox",0),t.log("Fading"),$("#sr_lightbox").fadeIn("fast",function(){return t.log("Finished"),r.show_activity(e,n)})},i.close=function(){var e=this;return t.log("Closing lightbox",0),t.log("Fading out"),$("#sr_lightbox").fadeOut(function(){return $("#sr_lightbox #sr_lightbox_inner").html(""),t.log("Html lightbox inner set to blank"),t.log("Finished")})},i.show_activity=function(e,n){var i=this;$("#sr_lightbox_inner").html("			<h3>Recent activity</h3>			<a id='sr_close_lightbox'>Close</a>			<div id='sr_loading'><img src='"+this.site.plugin_url+"/images/ajax-loader.gif' alt='Loading...'></div>			<ul id='sr_activity_tabs'>				<li id='sr_lightbox_everyone' class='sr_active_tab'><a>Everyone</a></li>				<li id='sr_lightbox_me'><a>Just you</a></li>			</ul>			<div id='sr_reads_list'><ul></ul></div>		");var s,o,u,a,f,l;t.log("Putting reads into the lightbox",0),$("#sr_loading").hide(),t.log("Found "+n.activity.reads.length+" reads"),s="",l=n.activity.reads;for(a=0,f=l.length;a<f;a++){o=l[a],o.from.id===n.user.id?u="sr_me_story":u="sr_friend_story";if(!o.data||!o.data.article)continue;s+="<li id='sr_read_"+o.id+"' class='"+u+"'>						<a class='name' href='//facebook.com/"+o.from.id+"' target='blank'>							<img class='story-img' src='https://graph.facebook.com/"+o.from.id+"/picture' width='50' height='50' alt='"+o.from.name+"' />						</a>						<div class='story-inner'>							<div class='story-title'>								<a class='name' href='//facebook.com/profile.php?id="+o.from.id+"' target='blank'>									"+o.from.name+"								</a> read 								<a class='article' href='"+o.data.article.url+"' target='blank'>"+o.data.article.title+"</a>							</div>							<div class='story-meta'>								"+r.relative(o.publish_time)+"								<span>&middot; <a class='sr_story_delete'>Delete</a></span>							</div>						</div>						<div class='sr_clear'></div>					</li>"}return $("#sr_reads_list ul").html(s),t.log("Html put: SUCCESS"),t.log("Showing stuff"),$("#sr_activity_tabs").show(),$("#sr_reads_list").show(),t.log("Adding jQuery listener for filter tabs"),$("#sr_activity_tabs a").on("click",function(){return t.log("Lightbox activity tab click detected",0),$("#sr_activity_tabs li").removeClass("sr_active_tab"),t.log("Removed class from existing tab"),$(this).closest("li").addClass("sr_active_tab"),t.log("Added class to the clicked tab"),$(this).closest("li").attr("id")==="sr_lightbox_everyone"?(t.log("Everyone tab detected, show all stories"),$("#sr_reads_list ul li").show()):$(this).closest("li").attr("id")==="sr_lightbox_me"&&(t.log("Me tab detected, just show my stories"),$("#sr_reads_list ul li.sr_friend_story").hide()),t.log("Finished")}),t.log("Adding jQuery listener for deleting reads"),$(".sr_story_delete").on("click",function(){var e;return e=$(this).closest("li").attr("id").replace("sr_read_",""),i.model.fb_delete_read(e,function(e){return $("#sr_read_{read_id}").fadeOut(function(){return $("#sr_read_{read_id}").remove()})})}),t.log("Finished")},i}),define("app/controllers/sidebar",["require","app/helpers/debugger","app/models/user","app/controllers/lightbox"],function(e,t,n,r){var i={};return i.load=function(e,n){var r,i=this;if($("#sr_sidebar_box").length===0)return t.log("#sr_sidebar_box is not found, cannot load sidebar."),!1;i=this,t.log("Loading the sidebar",0),e.logged_in===!0?(t.log("User is logged in"),e.auto_sharing===!0?r="sr_sidebar_toggled_on":r="sr_sidebar_toggled_off",t.log("User auto-sharing is set to: "+e.auto_sharing),t.log("Putting html"),$("#sr_sidebar_box").html("       <div id='sr_sidebar_logged_in'>               <a target='blank' href='"+e.link+"'>            <img src='"+e.picture+"' width='50' height='50' alt='"+e.name+"' />         </a>          <div id='sr_sidebar_right'>           <div id='sr_sidebar_name'><a target='blank' href='"+e.link+"'>"+e.name+"</a></div>            <div id='sr_sidebar_promo'>"+n.login_meta+"</div>           <div id='sr_sidebar_logout'><a>Logout</a></div>         </div>          <div class='clear'></div>         <div id='sr_sidebar_bottom'>            <div class='sr_sidebar_toggle "+r+"'>             <a title='Auto sharing to Facebook is enabled'>"+n.auto_sharing_on+"</a>            </div>            <div id='sr_sidebar_activity'><a>"+n.activity+"</a></div>         </div>        </div>      "),$("#sr_sidebar_box").html()!==""?t.log("Html put: SUCCESS"):t.log("Html put: FAILURE"),this.setup_logged_in_listeners()):(t.log("User is not logged in, show login button"),t.log("Putting html"),$("#sr_sidebar_box").html("       <div id='sr_sidebar_logged_out'>                Login and read with your friends          <a id='sr_sidebar_login'><img src='"+n.plugin_url+"/images/facebooklogin.jpg' width='180' height='40' /></a>        </div>      "),$("#sr_sidebar_box").html()!==""?t.log("Html put: SUCCESS"):t.log("Html put: FAILURE"),t.log("Adding jQuery listener for login button click"),this.setup_logged_out_listeners())},i.setup_logged_in_listeners=function(){var e=this;t.log("Setup jQuery listener for toggle auto-sharing link click"),$("#sr_sidebar_box .sr_sidebar_toggle").on("click",function(){e.toggle_auto_sharing($(this))}),t.log("Setup jQuery listener activity link click"),$("#sr_sidebar_box #sr_sidebar_activity").on("click",function(){r.show("all_activity",n)}),t.log("Setup jQuery listener for logout link click"),$("#sr_sidebar_box #sr_sidebar_logout").on("click",function(){n.logout()}),t.log("Finished")},i.setup_logged_out_listeners=function(){$("#sr_sidebar_box #sr_sidebar_login").on("click",function(){$(this).css("opacity",.7),n.login()})},i.toggle_auto_sharing=function(e){e.attr("class").match(/sr_sidebar_toggled_on/)?(e.removeClass("sr_sidebar_toggled_on"),e.addClass("sr_sidebar_toggled_off"),n.set_auto_sharing(!1)):e.attr("class").match(/sr_sidebar_toggled_off/)&&(e.removeClass("sr_sidebar_toggled_off"),e.addClass("sr_sidebar_toggled_on"),n.set_auto_sharing(!0))},i}),define("app/main",["require","app/models/user","app/controllers/sidebar","app/controllers/lightbox"],function(e,t,n,r){$=window.jQuery,$(document).ready(function(){t.init(function(){n.load(t.user,t.site)},function(){r.load(t.user,t.site)})})});